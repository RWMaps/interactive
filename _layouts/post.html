<!DOCTYPE html>
<html>
<head>
<script>
// Use back-end canvas if available for better performance.
L_PREFER_CANVAS = true;
</script>
<script src='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.js'></script>
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="/resources/js/csv2geojson.js"></script>
<link href='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.css' rel='stylesheet' />
<link href="/resources/css/interactive.css" rel="stylesheet" type="text/css">
<title>{{ page.title }}</title>
</head>
<body>

<div id='intro'>
{{ content }}
</div>

<div id='map'></div>

<script>
  // Variables from post page.
  var center_lon = {{ page.center_lon }};
  var center_lat = {{ page.center_lat }};
  var zoom_min = {{ page.zoom_min }};
  var zoom_max = {{ page.zoom_max }};
  var zoom_default = {{ page.zoom_default }};
  var data_key = '{{ page.data_key }}';
  var data_sheet_id = '{{ page.data_sheet_id }}';

  // Define the style of the circle markers.
  var circle_min_size = 10000;
  var circle_options = {
    color: '#f00',      // Stroke color
    opacity: 0.8,         // Stroke opacity
    weight: 2,         // Stroke weight
    fillColor: '#ED1C24',  // Fill color
    fillOpacity: 0.6    // Fill opacity
  };

  // Defined the function used to style the markers.
  L.mapbox.marker.style = function (feature, latlon) {
    var radius = circle_min_size;
    if (feature.properties && feature.properties.circle_size) {
      // Get the circle size. Would be better not to have the comma.
      radius = parseInt(feature.properties.circle_size.replace(',', ''));
    }
    return L.circle(latlon, radius || circle_min_size, circle_options);
  };

  // Create a map and overwrite min, max zoom and set the center and default zoom level.
  var map = L.mapbox.map('map', 'reliefweb.1_AVMU_World', {
    zoomControl: false,
    minZoom: zoom_min,
    maxZoom: zoom_max
  }).setView([center_lon, center_lat], zoom_default);

  // Set zoom control to the right.
  new L.Control.Zoom({ position: 'topright' }).addTo(map);

  // Add custom popups to each using our custom feature properties.
  map.markerLayer.on('layeradd', function(e) {
    var marker = e.layer,
    feature = marker.feature;

    var camp = feature.properties.Name;
    var district = feature.properties.District
    var IDP_number = parseInt(feature.properties.IDP_family_130714) + parseInt(feature.properties.IDP_ind_130714);

    // Create custom popup content.
    var popupContent =  '<div class="marker-tooltip">' +
                        '<span class="camp">' + camp + ' camp</span>' + '</br>' +
                        '<span class="district">in ' + district + ' district</span>' + '</br>' +
                        '<span class="idp-number">' + IDP_number + '</span> IDPs' +
                        '</div>';

    // @see http://leafletjs.com/reference.html#popup
    marker.bindPopup(popupContent,{
      closeButton: false,
      minWidth: 100
    });
  });

  // Display the tooltip at the position of the marker when the mouse is over a marker.
  map.markerLayer.on('mouseover', function(e) {
    e.layer.openPopup();
  });
  map.markerLayer.on('mouseout', function(e) {
    e.layer.closePopup();
  });

  // Load the data from a "published" google spreadsheet.
  // File > Publish to Web > Select 'Sheet' > Start publishing.
  // Data_key is the spreadsheet key.
  var url = 'https://docs.google.com/spreadsheet/pub?key=' + data_key + '&single=true&gid=' + data_sheet_id + '&output=csv';
  $.get(url, function(data) {
    map.markerLayer.setGeoJSON(csv2geojson.csv2geojson(data));
  });
</script>
</body>
</html>
